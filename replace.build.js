var fs = require('fs');

console.log('Incrementing build number...');

const buildInfoContent = fs.readFileSync('build-info.json');

var metadata = JSON.parse(buildInfoContent);
metadata.build = metadata.build + 1;

fs.writeFileSync('build-info.json', JSON.stringify(metadata));

console.log(`Current build number: ${metadata.major}.${metadata.minor}.${metadata.build}`);
console.log('Converting example library/story...');

const exampleLibraryContent = fs.readFileSync('example.library.tln');
const examplePlaygroundContent = fs.readFileSync('example.playground.tln');
const exampleAdventureContent = fs.readFileSync('example.adventure.tln');

const formatContents = function(content){
    const replaceQuotesRegex = new RegExp('"', "g");
    const replaceCarriageReturnRegex = new RegExp("\r", "g");
    const replaceNewlineRegex = new RegExp("\n", "g");

    return content.toString()
        .replace(replaceQuotesRegex, '\\\"')
        .replace(replaceCarriageReturnRegex, "")
        .split("\n")
        .map(x => x.replace(replaceNewlineRegex, ""))
        .map(x => `\"${x}\\n\"`)
        .join(" + \n");          
};

const outputWarning = "// WARNING: This file is autogenerated, do not edit manually!";
const formattedLibraryContents = formatContents(exampleLibraryContent);
const formattedPlaygroundContents = formatContents(examplePlaygroundContent);
const formattedAdventureContents = formatContents(exampleAdventureContent);

const getLibraryFunction = `export function getExampleLibraryCode(){\n    return ${formattedLibraryContents};\n}`;
const getStoryFunction = `export function getExamplePlaygroundCode(){\n    return ${formattedPlaygroundContents};\n}`;
const getAdventureFunction = `export function getExampleAdventureCode(){\n    return ${formattedAdventureContents};\n}`;

const output = `${outputWarning}\n\n${getLibraryFunction}\n\n${getStoryFunction}\n\n${getAdventureFunction}`;

fs.writeFileSync("talon/TalonExamples.ts", output);

console.log("Converted examples!");

fs.copy